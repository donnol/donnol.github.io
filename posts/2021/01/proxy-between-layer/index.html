<!doctype html><html lang=en dir=ltr>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="go实现AOP #  假设有store，从数据库获取数据，其中有方法IUserStore.GetByID，传入id参数，返回用户信息:
type IUserStore interface { GetByID(ctx context.Context, id int) (User, error) } 另外有service，刚好有用户id并且需要拿到用户信息，于是依赖了上述IUserStore：
type IUserSrv interface { CheckUser(ctx context.Context, id int) error // 获取用户信息，然后检查用户某些属性 } type userImpl struct { userStore IUserStore } func (impl userImpl) CheckUser(ctx context.Context, id int) error { user, err := impl.userStore.GetByID(ctx, id) if err != nil { return err } // 使用user数据做一些操作  _ = user } 上面所描述的是一个最简单的情况，如果我们要在userImpl.CheckUser里对impl.userStore.GetByID方法调用添加耗时统计，依然十分简单。
func (impl userImpl) CheckUser(ctx context.Context, id int) error { begin := time.">
<meta name=theme-color content="#FFFFFF">
<meta name=color-scheme content="light dark"><meta property="og:title" content="go实现AOP">
<meta property="og:description" content="go实现AOP #  假设有store，从数据库获取数据，其中有方法IUserStore.GetByID，传入id参数，返回用户信息:
type IUserStore interface { GetByID(ctx context.Context, id int) (User, error) } 另外有service，刚好有用户id并且需要拿到用户信息，于是依赖了上述IUserStore：
type IUserSrv interface { CheckUser(ctx context.Context, id int) error // 获取用户信息，然后检查用户某些属性 } type userImpl struct { userStore IUserStore } func (impl userImpl) CheckUser(ctx context.Context, id int) error { user, err := impl.userStore.GetByID(ctx, id) if err != nil { return err } // 使用user数据做一些操作  _ = user } 上面所描述的是一个最简单的情况，如果我们要在userImpl.CheckUser里对impl.userStore.GetByID方法调用添加耗时统计，依然十分简单。
func (impl userImpl) CheckUser(ctx context.Context, id int) error { begin := time.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://donnol.github.io/posts/2021/01/proxy-between-layer/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-01-17T00:00:00+00:00">
<meta property="article:modified_time" content="2021-01-17T00:00:00+00:00">
<title>go实现AOP | 我的简单博客</title>
<link rel=manifest href=/manifest.json>
<link rel=icon href=/favicon.png type=image/x-icon>
<link rel=stylesheet href=/book.min.09a284f5a03730d86dde350d2c062b1514e48fdfebba7763941c0674ef65748f.css integrity="sha256-CaKE9aA3MNht3jUNLAYrFRTkj9/rundjlBwGdO9ldI8=" crossorigin=anonymous>
<script defer src=/flexsearch.min.js></script>
<script defer src=/en.search.min.2f6c787dff456306ffb86ea316c81d4846b139b5df8fd92c24284a4c8d6d6460.js integrity="sha256-L2x4ff9FYwb/uG6jFsgdSEaxObXfj9ksJChKTI1tZGA=" crossorigin=anonymous></script>
<script defer src=/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js integrity="sha256-b2+Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC+NdcPIvZhzk=" crossorigin=anonymous></script>
</head>
<body dir=ltr>
<input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control>
<main class="container flex">
<aside class=book-menu>
<div class=book-menu-content>
<nav>
<h2 class=book-brand>
<a class="flex align-center" href=/><span>我的简单博客</span>
</a>
</h2>
<div class=book-search>
<input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/>
<div class="book-search-spinner hidden"></div>
<ul id=book-search-results></ul>
</div>
<ul>
<li>
<input type=checkbox id=section-71121fe02c394c786aa5fdaffc9e5412 class=toggle checked>
<label for=section-71121fe02c394c786aa5fdaffc9e5412 class="flex justify-between">
<a role=button>2021</a>
</label>
<ul>
<li>
<input type=checkbox id=section-393d931b698132759df1a7089df0fcc8 class=toggle>
<label for=section-393d931b698132759df1a7089df0fcc8 class="flex justify-between">
<a role=button>12</a>
</label>
<ul>
<li>
<a href=https://donnol.github.io/posts/2021/12/etcd/>etcd</a>
</li>
<li>
<a href=https://donnol.github.io/posts/2021/12/vscode-go-module/>vscode-go在go.mod在非根目录情况下失效的问题</a>
</li>
<li>
<a href=https://donnol.github.io/posts/2021/12/mqtt/>mqtt</a>
</li>
<li>
<a href=https://donnol.github.io/posts/2021/12/redis_sds/>redis sds</a>
</li>
<li>
<a href=https://donnol.github.io/posts/2021/12/k8s/>k8s</a>
</li>
<li>
<a href=https://donnol.github.io/posts/2021/12/ddia/>数据密集型应用设计</a>
</li>
<li>
<a href=https://donnol.github.io/posts/2021/12/burn_cpu_use_golang/>burn cpu use golang</a>
</li>
<li>
<a href=https://donnol.github.io/posts/2021/12/docker_compose_extra_host/>docker compose使用extra host让容器访问主机服务</a>
</li>
<li>
<a href=https://donnol.github.io/posts/2021/12/dbeaver/>数据库管理工具之dbeaver</a>
</li>
<li>
<a href=https://donnol.github.io/posts/2021/12/domain/>Domain-oriented development</a>
</li>
<li>
<a href=https://donnol.github.io/posts/2021/12/github_action_deploy_hugo_blog/>github action deploy hugo blog</a>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-b59662e33ca9ad77b7d385cbee7785fe class=toggle>
<label for=section-b59662e33ca9ad77b7d385cbee7785fe class="flex justify-between">
<a role=button>07</a>
</label>
<ul>
<li>
<a href=https://donnol.github.io/posts/2021/07/linux-epoll/>linux epoll</a>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-3b66512bb507cbdaa9cef9549f229fc1 class=toggle checked>
<label for=section-3b66512bb507cbdaa9cef9549f229fc1 class="flex justify-between">
<a role=button>01</a>
</label>
<ul>
<li>
<a href=https://donnol.github.io/posts/2021/01/proxy-between-layer/ class=active>go实现AOP</a>
</li>
<li>
<a href=https://donnol.github.io/posts/2021/01/hugo-blog/>hugo搭建博客</a>
</li>
<li>
<a href=https://donnol.github.io/posts/2021/01/pstree/>pstree进程树及说明</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-6f89cc6c76d5375fc02e3f7e596280b9 class=toggle>
<label for=section-6f89cc6c76d5375fc02e3f7e596280b9 class="flex justify-between">
<a role=button>2020</a>
</label>
<ul>
<li>
<input type=checkbox id=section-03db05476b76e7f4afe06dfa3e1b675b class=toggle>
<label for=section-03db05476b76e7f4afe06dfa3e1b675b class="flex justify-between">
<a role=button>12</a>
</label>
<ul>
<li>
<a href=https://donnol.github.io/posts/2020/12/go-ctx/>go ctx</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href=https://donnol.github.io/posts/aboutme/about-me/>关于我</a>
</li>
</ul>
<ul>
<li>
<a href=https://github.com/donnol/blog target=_blank rel=noopener>
Github
</a>
</li>
<li>
<a href=https://themes.gohugo.io/hugo-book/ target=_blank rel=noopener>
Hugo Themes
</a>
</li>
</ul>
</nav>
<script>(function(){var a=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(b){localStorage.setItem("menu.scrollTop",a.scrollTop)}),a.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>
</div>
</aside>
<div class=book-page>
<header class=book-header>
<div class="flex align-center justify-between">
<label for=menu-control>
<img src=/svg/menu.svg class=book-icon alt=Menu>
</label>
<strong>go实现AOP</strong>
<label for=toc-control>
<img src=/svg/toc.svg class=book-icon alt="Table of Contents">
</label>
</div>
<aside class="hidden clearfix">
<nav id=TableOfContents>
<ul>
<li>
<ul>
<li><a href=#go实现aop>go实现AOP</a></li>
<li><a href=#有兴趣的话可以看这里的实现httpsgithubcomdonnoltoolsblobmasterinjectproxygo><a href=https://github.com/donnol/tools/blob/master/inject/proxy.go>有兴趣的话，可以看这里的实现</a></a></li>
<li><a href=#这里的示例httpsgithubcomdonnoltoolsblobmasterinjectproxy_testgo><a href=https://github.com/donnol/tools/blob/master/inject/proxy_test.go>这里的示例</a></a></li>
</ul>
</li>
</ul>
</nav>
</aside>
</header>
<article class=markdown>
<h1>
<a href=/posts/2021/01/proxy-between-layer/>go实现AOP</a>
</h1>
<h5>January 17, 2021</h5>
<div>
<a href=/categories/go/>go</a>
</div>
<div>
<a href=/tags/aop/>aop</a>
</div>
<h2 id=go实现aop>
go实现AOP
<a class=anchor href=#go%e5%ae%9e%e7%8e%b0aop>#</a>
</h2>
<p>假设有store，从数据库获取数据，其中有方法IUserStore.GetByID，传入id参数，返回用户信息:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>IUserStore</span> <span style=color:#66d9ef>interface</span> {
        <span style=color:#a6e22e>GetByID</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>id</span> <span style=color:#66d9ef>int</span>) (<span style=color:#a6e22e>User</span>, <span style=color:#66d9ef>error</span>)
}
</code></pre></div><p>另外有service，刚好有用户id并且需要拿到用户信息，于是依赖了上述IUserStore：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>IUserSrv</span> <span style=color:#66d9ef>interface</span> {
        <span style=color:#a6e22e>CheckUser</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>id</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>error</span> <span style=color:#75715e>// 获取用户信息，然后检查用户某些属性
</span><span style=color:#75715e></span>} 

<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>userImpl</span> <span style=color:#66d9ef>struct</span> {
        <span style=color:#a6e22e>userStore</span> <span style=color:#a6e22e>IUserStore</span>
}

<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>impl</span> <span style=color:#a6e22e>userImpl</span>) <span style=color:#a6e22e>CheckUser</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>id</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>error</span> {
        <span style=color:#a6e22e>user</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>impl</span>.<span style=color:#a6e22e>userStore</span>.<span style=color:#a6e22e>GetByID</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>id</span>)
        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
                <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
        }

        <span style=color:#75715e>// 使用user数据做一些操作
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>user</span>
}
</code></pre></div><p>上面所描述的是一个最简单的情况，如果我们要在userImpl.CheckUser里对impl.userStore.GetByID方法调用添加耗时统计，依然十分简单。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>impl</span> <span style=color:#a6e22e>userImpl</span>) <span style=color:#a6e22e>CheckUser</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>id</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>error</span> {
        <span style=color:#a6e22e>begin</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()
        <span style=color:#a6e22e>user</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>impl</span>.<span style=color:#a6e22e>userStore</span>.<span style=color:#a6e22e>GetByID</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>id</span>)
        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
                <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
        }
        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Since</span>(<span style=color:#a6e22e>begin</span>)) <span style=color:#75715e>// 统计耗时
</span><span style=color:#75715e></span>
        <span style=color:#75715e>// 使用user数据做一些操作
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>user</span>
}
</code></pre></div><p>但是，如果方法里调用的类似impl.userStore.GetByID的方法非常之多，逻辑非常之复杂时，这样一个一个的添加，必然非常麻烦、非常累。</p>
<p>这时，如果有一个层间代理能帮我们拦截store的方法调用，在调用前后添加上耗时统计，势必能大大提升我们的工作效率。</p>
<p>比如：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Around</span>(<span style=color:#a6e22e>f</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>args</span> []<span style=color:#66d9ef>interface</span>{}) []<span style=color:#66d9ef>interface</span>{}, <span style=color:#a6e22e>args</span> []<span style=color:#66d9ef>interface</span>{}) []<span style=color:#66d9ef>interface</span>{} {
        <span style=color:#a6e22e>begin</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()
        <span style=color:#a6e22e>r</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>f</span>(<span style=color:#a6e22e>args</span>)
        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Since</span>(<span style=color:#a6e22e>begin</span>)) <span style=color:#75715e>// 统计耗时
</span><span style=color:#75715e></span>
        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>r</span>
}
</code></pre></div><p>这只是一个简单的包装函数，怎么能将它与上面的接口联系到一起呢？</p>
<h2 id=有兴趣的话可以看这里的实现httpsgithubcomdonnoltoolsblobmasterinjectproxygo>
<a href=https://github.com/donnol/tools/blob/master/inject/proxy.go>有兴趣的话，可以看这里的实现</a>
<a class=anchor href=#%e6%9c%89%e5%85%b4%e8%b6%a3%e7%9a%84%e8%af%9d%e5%8f%af%e4%bb%a5%e7%9c%8b%e8%bf%99%e9%87%8c%e7%9a%84%e5%ae%9e%e7%8e%b0httpsgithubcomdonnoltoolsblobmasterinjectproxygo>#</a>
</h2>
<p>可以看到，主要的方法是<code>Around(provider interface{}, mock interface{}, arounder Arounder) interface{}</code>，
其中provider参数是类似<code>NewXXX() IXXX</code>的函数，而mock是IXXX接口的一个实现，最后的Arounder是
拥有方法<code>Around(pctx ProxyContext, method reflect.Value, args []reflect.Value) []reflect.Value</code>的接口。</p>
<h2 id=这里的示例httpsgithubcomdonnoltoolsblobmasterinjectproxy_testgo>
<a href=https://github.com/donnol/tools/blob/master/inject/proxy_test.go>这里的示例</a>
<a class=anchor href=#%e8%bf%99%e9%87%8c%e7%9a%84%e7%a4%ba%e4%be%8bhttpsgithubcomdonnoltoolsblobmasterinjectproxy_testgo>#</a>
</h2>
<p>可以看到，mock结构是长这样的：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>UserMock</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#a6e22e>AddFunc</span>        <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>name</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>int</span>
	<span style=color:#a6e22e>GetHelper</span>      <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>id</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`method:&#34;Get&#34;`</span> <span style=color:#75715e>// 表示这个字段关联的方法是Get
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>GetContextFunc</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>id</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>string</span>
}
</code></pre></div><p>所以，为了提升开发效率，我还写了一个
<a href=https://github.com/donnol/tools>工具</a>，用来根据接口生成相应的mock结构体。</p>
</article>
<footer class=book-footer>
<div class="flex flex-wrap justify-between">
</div>
<script>(function(){function a(c){const a=window.getSelection(),b=document.createRange();b.selectNodeContents(c),a.removeAllRanges(),a.addRange(b)}document.querySelectorAll("pre code").forEach(b=>{b.addEventListener("click",function(c){a(b.parentElement),navigator.clipboard&&navigator.clipboard.writeText(b.parentElement.textContent)})})})()</script>
</footer>
<div class=book-comments>
<div id=disqus_thread></div>
<script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//donno272.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</div>
<label for=menu-control class="hidden book-menu-overlay"></label>
</div>
<aside class=book-toc>
<div class=book-toc-content>
<nav id=TableOfContents>
<ul>
<li>
<ul>
<li><a href=#go实现aop>go实现AOP</a></li>
<li><a href=#有兴趣的话可以看这里的实现httpsgithubcomdonnoltoolsblobmasterinjectproxygo><a href=https://github.com/donnol/tools/blob/master/inject/proxy.go>有兴趣的话，可以看这里的实现</a></a></li>
<li><a href=#这里的示例httpsgithubcomdonnoltoolsblobmasterinjectproxy_testgo><a href=https://github.com/donnol/tools/blob/master/inject/proxy_test.go>这里的示例</a></a></li>
</ul>
</li>
</ul>
</nav>
</div>
</aside>
</main>
</body>
</html>